<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dynamics & Mechanisms Master Quiz</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            /* Slate/Ocean Theme */
            --primary: #37474f;
            --secondary: #0277bd;
            --accent: #ff6f00;
            --background: #f4f6f8;
            --surface: #ffffff;
            --success: #2e7d32;
            --danger: #c62828;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background);
            margin: 0; padding: 0; display: flex; height: 100vh; color: #333; overflow: hidden;
        }

        /* --- Mobile Header --- */
        .mobile-header {
            display: none; height: var(--header-height); background: var(--primary);
            align-items: center; padding: 0 15px; justify-content: space-between;
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); color: white;
        }
        .mobile-menu-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; }
        .mobile-timer { font-weight: bold; font-variant-numeric: tabular-nums; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 4px; color: #81d4fa; }

        /* --- Sidebar --- */
        .sidebar {
            width: 320px; background-color: var(--primary); color: white;
            display: flex; flex-direction: column; padding: 20px;
            box-shadow: 4px 0 15px rgba(0,0,0,0.2); overflow-y: auto; z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 90; backdrop-filter: blur(2px); }

        .timer-container {
            background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;
            text-align: center; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2);
        }
        .timer-display { font-size: 2.5em; font-weight: 700; font-variant-numeric: tabular-nums; margin-top: 5px; color: #81d4fa; }
        .timer-warning { color: var(--accent); animation: pulse 1s infinite; }

        .grid-label { font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        .question-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .nav-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 10px 0; border-radius: 4px; cursor: pointer;
            transition: all 0.2s; font-size: 0.9em;
        }
        .nav-btn:hover { background: var(--secondary); transform: translateY(-2px); }
        .nav-btn.active { background: var(--secondary); border-color: #81d4fa; font-weight: bold; box-shadow: 0 0 10px rgba(129, 212, 250, 0.5); }
        .nav-btn.answered { background: var(--success); border-color: var(--success); }
        .nav-btn.flagged { border-color: var(--accent); color: var(--accent); background: rgba(255, 111, 0, 0.2); }

        /* --- Main Content --- */
        .main-content {
            flex: 1; padding: 40px; overflow-y: auto; position: relative;
        }
        .quiz-card {
            max-width: 900px; margin: 0 auto; background: var(--surface); padding: 50px;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            animation: fadeIn 0.4s ease-out; border-top: 6px solid var(--secondary);
        }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eceff1; padding-bottom: 15px; }
        .question-text { font-size: 1.3em; line-height: 1.6; margin-bottom: 35px; color: #263238; }
        .options-grid { display: grid; gap: 15px; }
        .option-label {
            display: flex; align-items: center; padding: 18px 25px;
            border: 2px solid #eceff1; border-radius: 8px; cursor: pointer;
            transition: all 0.2s; font-size: 1.05em;
        }
        .option-label:hover { background-color: #e1f5fe; border-color: var(--secondary); }
        .option-label.selected { background-color: #e1f5fe; border-color: var(--secondary); box-shadow: 0 2px 8px rgba(2, 119, 189, 0.15); }
        input[type="radio"] { margin-right: 15px; transform: scale(1.3); accent-color: var(--secondary); flex-shrink: 0;}
        .badge { background: #e3f2fd; color: var(--secondary); padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.9em; }

        .controls { display: flex; justify-content: space-between; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eceff1; }
        .btn { padding: 12px 30px; border: none; border-radius: 6px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: #cfd8dc; color: #455a64; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-accent { background: white; border: 2px solid var(--accent); color: var(--accent); }
        .btn-success { background: var(--success); color: white; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(38, 50, 56, 0.9); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 50px; border-radius: 15px; text-align: center; max-width: 500px; width: 90%; animation: slideUp 0.4s ease; max-height: 90vh; overflow-y: auto; }
        .score-circle { width: 160px; height: 160px; border-radius: 50%; border: 10px solid var(--secondary); margin: 20px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 3em; font-weight: 800; color: var(--primary); }
        .score-label { font-size: 0.3em; color: #78909c; font-weight: 600; text-transform: uppercase; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .mjx-chtml { outline: 0; }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 900px) {
            body { flex-direction: column; }
            .mobile-header { display: flex; }
            .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 85%; max-width: 320px; transform: translateX(-100%); border-right: none; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { padding: 20px; padding-top: calc(var(--header-height) + 20px); }
            .quiz-card { padding: 25px; border-radius: 8px; }
            .question-text { font-size: 1.1em; }
            .option-label { padding: 15px; font-size: 0.95em; }
            .controls { flex-direction: column; gap: 15px; }
            .controls > button { width: 100%; }
            .controls > div { display: flex; width: 100%; gap: 10px; }
            .controls > div > button { flex: 1; }
            .sidebar .timer-container { display: none; }
        }
    </style>
</head>
<body>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<header class="mobile-header">
    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
    <span style="font-weight:700; font-size: 1.1em;">Master Quiz</span>
    <div class="mobile-timer" id="mobileTimer">60:00</div>
</header>

<div class="sidebar" id="sidebar">
    <div class="timer-container">
        <div style="font-size: 0.9em; text-transform: uppercase; opacity: 0.8;">Time Remaining</div>
        <div class="timer-display" id="timer">60:00</div>
    </div>
    <div class="grid-label">Question Map</div>
    <div class="question-nav" id="navGrid"></div>
</div>

<div class="main-content">
    <div class="quiz-card" id="quizContainer">
        <div class="header-row">
            <h2 style="margin:0; color: var(--primary); font-size: 1.2rem;">Question <span id="currentQNum">1</span> <span style="color:#b0bec5; font-weight:300;">/ 50</span></h2>
            <div class="badge" id="topicBadge">Topic</div>
        </div>

        <div class="question-text" id="questionText"></div>
        <div class="options-grid" id="optionsContainer"></div>

        <div class="controls">
            <button class="btn btn-accent" id="flagBtn" onclick="toggleFlag()">
                <span id="flagIcon">⚑</span> Flag
            </button>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" id="prevBtn" onclick="changeQuestion(-1)">Previous</button>
                <button class="btn btn-primary" id="nextBtn" onclick="changeQuestion(1)">Next</button>
                <button class="btn btn-success" id="submitBtn" style="display:none;" onclick="submitQuiz()">Submit</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="resultModal">
    <div class="modal-content">
        <h2 style="color: var(--primary);">Quiz Completed!</h2>
        <p>Your final comprehensive score.</p>
        <div class="score-circle">
            <span id="finalScore">0</span>
            <span class="score-label">Marks / 100</span>
        </div>
        <p id="feedbackText" style="margin-top:20px; font-size:1.1em;"></p>

        <div style="display:flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top:20px;">
            <button class="btn btn-secondary" onclick="window.close()">Return to Dashboard</button>
            <button class="btn btn-primary" onclick="location.reload()">Retake Quiz</button>
        </div>
    </div>
</div>

<script>
    // --- INTEGRATION CONFIGURATION ---
    // This MUST match the index in your Dashboard (index.html)
    // Quiz 05: Advanced Topics is Index 23
    const QUIZ_ID = "q_23";
    const QUIZ_TITLE = "Quiz 05: Advanced Topics";

    // --- Quiz Data ---
    const rawQuizData = [
        { topic: "MEMS", q: "What does the acronym MEMS stand for?", options: ["Micro Electronic Magnetic Systems", "Micro Electro-Mechanical Systems", "Macro Electric Mechanical Sensors", "Miniature Energy Management Systems"], correct: 1 },
        { topic: "MEMS", q: "Which fabrication technique involves etching away parts of the silicon substrate to form mechanical structures?", options: ["Surface Micromachining", "Bulk Micromachining", "LIGA", "Wire Bonding"], correct: 1 },
        { topic: "MEMS", q: "In an accelerometer, the ratio of change in deflection (x) to acceleration (a) represents the sensitivity. Formulaically, \\( x/a \\) is equal to:", options: ["\\( k/m \\)", "\\( m/k \\)", "\\( F \\times m \\)", "\\( k \\times x \\)"], correct: 1 },
        { topic: "MEMS", q: "Which type of accelerometer measures acceleration by sensing the change in the gap between moving plates?", options: ["Piezoelectric", "Capacitive", "Heat Transfer", "Hall Effect"], correct: 1 },
        { topic: "MEMS", q: "What is 'Proper Acceleration'?", options: ["Acceleration relative to the earth", "Acceleration in a fixed coordinate system", "The acceleration of a body in its own instantaneous rest frame", "Acceleration due to gravity"], correct: 2 },
        { topic: "MEMS", q: "What does an accelerometer in free fall measure?", options: ["9.81 \\(m/s^2\\)", "Zero", "Infinity", "Terminal Velocity"], correct: 1 },
        { topic: "MEMS", q: "Which advanced fabrication technique is used for high-aspect-ratio microstructures?", options: ["Wet Etching", "LIGA", "Chemical Vapor Deposition", "Sputtering"], correct: 1 },
        { topic: "MEMS", q: "In the automotive industry, MEMS accelerometers are critically used for:", options: ["Navigation only", "Airbag deployment", "Fuel injection", "Radio tuning"], correct: 1 },
        { topic: "MEMS", q: "A piezoelectric accelerometer works on the principle that:", options: ["Resistance changes with stress", "Capacitance changes with distance", "A squeezed crystal generates voltage", "Magnetic fields induce current"], correct: 2 },
        { topic: "MEMS", q: "Which material is most commonly used as a substrate in MEMS fabrication?", options: ["Aluminum", "Plastic", "Silicon", "Copper"], correct: 2 },
        { topic: "Gyroscopes", q: "What are the two basic properties of a gyroscope?", options: ["Rigidity and Flexibility", "Rigidity and Precession", "Rotation and Translation", "Spin and Gravity"], correct: 1 },
        { topic: "Gyroscopes", q: "The axis of rotation of a gyro wheel tends to remain in a fixed direction in space if no force is applied. This property is called:", options: ["Precession", "Rigidity", "Inertia", "Momentum"], correct: 1 },
        { topic: "Gyroscopes", q: "The Gyroscopic Couple \\(C\\) is given by the formula:", options: ["\\( I \\omega^2 \\)", "\\( I \\omega \\omega_p \\)", "\\( I \\alpha \\)", "\\( m v^2 / r \\)"], correct: 1 },
        { topic: "Gyroscopes", q: "If you rotate the spin vector through 90° in the direction of precession, it will point in the direction of:", options: ["The applied torque vector", "The weight vector", "The reaction torque", "The friction vector"], correct: 0 },
        { topic: "Gyroscopes", q: "In a ship, the gyroscopic effect during steering causes the bow (front) to:", options: ["Move left or right only", "Rise or fall (Pitch)", "Roll continuously", "Stop moving"], correct: 1 },
        { topic: "Gyroscopes", q: "The axis about which the axis of spin turns is known as:", options: ["Torque axis", "Precession axis", "Couple axis", "Gravitational axis"], correct: 1 },
        { topic: "Gyroscopes", q: "What is the angular momentum \\(H\\) defined as?", options: ["\\( H = m v \\)", "\\( H = I \\omega \\)", "\\( H = I \\alpha \\)", "\\( H = m r^2 \\)"], correct: 1 },
        { topic: "Gyroscopes", q: "When a vehicle turns a corner, the gyroscopic couple acts to:", options: ["Increase speed", "Decrease speed", "Overturn or stabilize the vehicle (affecting wheel reactions)", "Stop the engine"], correct: 2 },
        { topic: "Gyroscopes", q: "Which type of gyroscope uses light interference to detect rotation?", options: ["Mechanical Gyro", "MEMS Gyro", "Fiber Optic Gyro (FOG)", "Gas-Bearing Gyro"], correct: 2 },
        { topic: "Gyroscopes", q: "Calculate the precessional velocity \\(\\omega_p\\) if the Applied Couple \\(C = 10\\) Nm, Moment of Inertia \\(I = 0.5\\) kg-m², and Spin Velocity \\(\\omega = 20\\) rad/s.", options: ["0.5 rad/s", "1.0 rad/s", "2.0 rad/s", "10 rad/s"], correct: 1 },
        { topic: "Gyroscopes", q: "In a racing car engine, the rotating parts act as a gyroscope. If the engine spins clockwise and the car turns left, the gyroscopic couple will tend to:", options: ["Lift the nose", "Dip the nose", "Roll the car", "Slide the rear"], correct: 0 },
        { topic: "Gyroscopes", q: "The 'Active Gyroscopic Couple' and the 'Reactive Gyroscopic Couple' are:", options: ["Equal and in the same direction", "Equal and opposite", "Unrelated", "Perpendicular"], correct: 1 },
        { topic: "Gyroscopes", q: "Which component in a mechanical gyroscope allows the rotor to rotate freely in 3 dimensions?", options: ["The Shaft", "The Gimbals", "The Base", "The Motor"], correct: 1 },
        { topic: "Cams", q: "A cam and follower mechanism constitutes which type of kinematic pair?", options: ["Lower Pair", "Higher Pair", "Rolling Pair", "Screw Pair"], correct: 1 },
        { topic: "Cams", q: "The smallest circle that can be drawn to the cam profile is called the:", options: ["Pitch circle", "Prime circle", "Base circle", "Trace circle"], correct: 2 },
        { topic: "Cams", q: "For a roller follower, the curve generated by the trace point (center of the roller) is called the:", options: ["Cam Profile", "Pitch Curve", "Base Curve", "Prime Curve"], correct: 1 },
        { topic: "Cams", q: "The angle between the direction of follower motion and the normal to the pitch curve is the:", options: ["Pressure Angle", "Cam Angle", "Dwell Angle", "Base Angle"], correct: 0 },
        { topic: "Cams", q: "Which follower type has the advantage of lower friction and wear?", options: ["Knife-edge", "Flat-faced", "Roller", "Spherical-faced"], correct: 2 },
        { topic: "Cams", q: "Which circle is drawn from the center of the cam tangent to the pitch curve?", options: ["Base circle", "Prime circle", "Addendum circle", "Pitch circle"], correct: 1 },
        { topic: "Cams", q: "During 'Dwell', the follower:", options: ["Moves upward", "Moves downward", "Remains at rest", "Accelerates"], correct: 2 },
        { topic: "Cams", q: "For Simple Harmonic Motion (SHM), the maximum velocity \\(v_{max}\\) during the outstroke is:", options: ["\\( \\frac{2 \\omega S}{\\theta} \\)", "\\( \\frac{\\pi \\omega S}{2\\theta} \\)", "\\( \\frac{4 \\omega S}{\\theta} \\)", "\\( \\frac{\\omega S}{\\theta} \\)"], correct: 1 },
        { topic: "Cams", q: "For Uniform Acceleration and Retardation (UARM), the displacement diagram consists of:", options: ["Straight lines", "Sine curves", "Parabolic curves", "Cycloidal curves"], correct: 2 },
        { topic: "Cams", q: "Which motion profile provides the lowest vibration at high speeds due to finite jerk?", options: ["Uniform Velocity", "Simple Harmonic Motion", "Uniform Acceleration", "Cycloidal Motion"], correct: 3 },
        { topic: "Cams", q: "In a Radial Cam, the follower moves:", options: ["Parallel to the cam axis", "Perpendicular to the cam axis", "In a circle", "At 45 degrees"], correct: 1 },
        { topic: "Cams", q: "For a Knife-Edge follower, the Pitch Curve and the Cam Profile are:", options: ["Separated by the radius", "Identical", "Perpendicular", "Inverse"], correct: 1 },
        { topic: "Cams", q: "The maximum acceleration for a follower moving with Cycloidal motion is:", options: ["\\( \\frac{4 \\omega^2 S}{\\theta^2} \\)", "\\( \\frac{\\pi^2 \\omega^2 S}{2\\theta^2} \\)", "\\( \\frac{2\\pi \\omega^2 S}{\\theta^2} \\)", "\\( \\infty \\)"], correct: 2 },
        { topic: "Cams", q: "If a cam rotates at uniform speed and the follower rises with Uniform Velocity, the acceleration at the start of the rise is:", options: ["Zero", "Finite and constant", "Infinite (theoretical jerk)", "Negative"], correct: 2 },
        { topic: "Cams", q: "The 'Stroke' or 'Lift' of a follower is:", options: ["The diameter of the base circle", "The maximum travel from lowest to highest position", "The circumference of the cam", "The length of the follower"], correct: 1 },
        { topic: "Cams", q: "A 'Tangent Cam' with straight flanks is commonly used in:", options: ["Textile machines", "ICE inlet/exhaust valves", "Lathe feed mechanisms", "Paper cutting machines"], correct: 1 },
        { topic: "Cams", q: "If the follower axis does not pass through the cam axis, it is called an:", options: ["Offset follower", "Radial follower", "Oscillating follower", "Aligned follower"], correct: 0 },
        { topic: "Calculations", q: "SHM Calculation: Stroke \\(S = 0.04\\)m, Angle \\(\\theta = 1.57\\) rad, Angular velocity \\(\\omega = 25\\) rad/s. Find \\(V_{max}\\). Formula: \\( \\frac{\\pi \\omega S}{2\\theta} \\).", options: ["0.5 m/s", "1.0 m/s", "1.5 m/s", "2.0 m/s"], correct: 1 },
        { topic: "Calculations", q: "UARM Calculation: Stroke \\(S = 40\\)mm, Angle \\(\\theta = 1.745\\) rad, \\(\\omega = 94\\) rad/s. Find \\(V_{max} = \\frac{2 \\omega S}{\\theta}\\).", options: ["4300 mm/s", "4.3 m/s", "2.15 m/s", "8.6 m/s"], correct: 1 },
        { topic: "Calculations", q: "Gyro Calculation: A disc has \\(I = 10\\) kgm². It spins at 10 rad/s. What is its Angular Momentum?", options: ["1 kgm²/s", "10 kgm²/s", "100 kgm²/s", "5 kgm²/s"], correct: 2 },
        { topic: "Theory", q: "In a Cylindrical Cam, the follower moves in a direction:", options: ["Perpendicular to the cam axis", "Parallel to the cam axis", "Tangential to the cam", "Radial to the cam"], correct: 1 },
        { topic: "Theory", q: "Which accelerometer uses a heated mass tracked by temperature sensors?", options: ["Piezoelectric", "Heat Transfer", "Capacitive", "Hall Effect"], correct: 1 },
        { topic: "Theory", q: "The 'Trace Point' for a Spherical Faced follower is:", options: ["The contact point", "The center of the spherical face", "The knife edge", "The cam center"], correct: 1 },
        { topic: "Theory", q: "What is the effect of an Offset follower?", options: ["Reduces side thrust on the guide", "Increases wear", "Increases pressure angle", "Decreases lift"], correct: 0 },
        { topic: "Theory", q: "A 'Rate Gyro' is primarily used to measure:", options: ["Position", "Rate of turn (Angular velocity)", "Linear acceleration", "Temperature"], correct: 1 },
        { topic: "Theory", q: "The 'Pitch Point' on a cam pitch curve has the:", options: ["Minimum pressure angle", "Maximum pressure angle", "Zero pressure angle", "Infinite pressure angle"], correct: 1 },
        { topic: "Theory", q: "MEMS fabrication: What is 'Etching'?", options: ["Adding material layers", "Patterning layers with light", "Removing unwanted material", "Bonding wires"], correct: 2 }
    ];

    // --- State Variables ---
    let quizData = [];
    let currentQuestion = 0;
    let userAnswers = [];
    let flaggedQuestions = [];
    let timeLeft = 60 * 60; // 60 minutes
    let timerInterval;

    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const mobileTimer = document.getElementById('mobileTimer');
    const desktopTimer = document.getElementById('timer');

    // --- Shuffle Function ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        quizData = shuffleArray([...rawQuizData]);
        userAnswers = new Array(quizData.length).fill(null);
        flaggedQuestions = new Array(quizData.length).fill(false);

        initNavigation();
        loadQuestion(0);
        startTimer();
    });

    // --- Sidebar / Mobile Functions ---
    function toggleSidebar() {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
        overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
    }

    // --- Core Functions ---
    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            const timeString = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

            desktopTimer.textContent = timeString;
            mobileTimer.textContent = timeString;

            if(timeLeft <= 300) {
                desktopTimer.classList.add('timer-warning');
                mobileTimer.style.color = 'var(--accent)';
            }
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz();
            }
        }, 1000);
    }

    function initNavigation() {
        const grid = document.getElementById('navGrid');
        grid.innerHTML = '';
        quizData.forEach((_, i) => {
            const btn = document.createElement('button');
            btn.className = 'nav-btn';
            btn.textContent = i + 1;
            btn.onclick = () => {
                loadQuestion(i);
                if(window.innerWidth <= 900) toggleSidebar();
            };
            btn.id = `nav-${i}`;
            grid.appendChild(btn);
        });
    }

    function loadQuestion(index) {
        currentQuestion = index;
        const qData = quizData[index];

        document.getElementById('currentQNum').textContent = index + 1;
        document.getElementById('topicBadge').textContent = qData.topic;
        document.getElementById('questionText').innerHTML = qData.q;

        const container = document.getElementById('optionsContainer');
        container.innerHTML = '';

        qData.options.forEach((opt, i) => {
            const label = document.createElement('label');
            label.className = 'option-label';
            if(userAnswers[index] === i) label.classList.add('selected');

            const input = document.createElement('input');
            input.type = 'radio'; input.name = 'qOption'; input.value = i;
            input.checked = userAnswers[index] === i;
            input.onchange = () => selectOption(i);

            const span = document.createElement('span');
            span.innerHTML = opt;

            label.appendChild(input);
            label.appendChild(span);
            container.appendChild(label);
        });

        if(window.MathJax) MathJax.typesetPromise([document.getElementById('questionText'), container]);

        document.getElementById('prevBtn').disabled = index === 0;
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        if(index === quizData.length - 1) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'flex';
        } else {
            nextBtn.style.display = 'flex';
            submitBtn.style.display = 'none';
        }

        const flagBtn = document.getElementById('flagBtn');
        if(flaggedQuestions[index]) {
            flagBtn.classList.add('active');
            flagBtn.innerHTML = '<span id="flagIcon">⚑</span> Flagged';
        } else {
            flagBtn.classList.remove('active');
            flagBtn.innerHTML = '<span id="flagIcon">⚑</span> Flag';
        }

        updateNavStyles();
    }

    function selectOption(i) {
        userAnswers[currentQuestion] = i;
        const labels = document.querySelectorAll('.option-label');
        labels.forEach((l, idx) => {
            if(idx === i) l.classList.add('selected');
            else l.classList.remove('selected');
        });
        updateNavStyles();
    }

    function changeQuestion(delta) {
        const next = currentQuestion + delta;
        if(next >= 0 && next < quizData.length) loadQuestion(next);
    }

    function toggleFlag() {
        flaggedQuestions[currentQuestion] = !flaggedQuestions[currentQuestion];
        loadQuestion(currentQuestion);
    }

    function updateNavStyles() {
        quizData.forEach((_, i) => {
            const btn = document.getElementById(`nav-${i}`);
            btn.className = 'nav-btn';
            if(i === currentQuestion) btn.classList.add('active');
            if(userAnswers[i] !== null) btn.classList.add('answered');
            if(flaggedQuestions[i]) btn.classList.add('flagged');
        });
    }

    // --- INTEGRATED SUBMIT FUNCTION ---
    function submitQuiz() {
        clearInterval(timerInterval);

        let rawScore = 0;
        userAnswers.forEach((ans, i) => {
            if(ans === quizData[i].correct) rawScore++;
        });

        // 50 questions, each worth 2 marks = 100
        const finalPercentage = rawScore * 2;

        // 1. SAVE TO DASHBOARD
        let allQuizData = JSON.parse(localStorage.getItem('quizData')) || {};
        let currentRecord = allQuizData[QUIZ_ID] || { title: QUIZ_TITLE, attempts: 0, score: 0 };
        currentRecord.score = Math.max(currentRecord.score, finalPercentage);
        if(currentRecord.attempts === 0) currentRecord.attempts = 1;

        allQuizData[QUIZ_ID] = currentRecord;
        localStorage.setItem('quizData', JSON.stringify(allQuizData));

        // 2. SHOW RESULTS
        const scoreElement = document.getElementById('finalScore');
        const feedbackElement = document.getElementById('feedbackText');

        let displayScore = 0;
        const anim = setInterval(() => {
            if(displayScore < finalPercentage) {
                displayScore += 2;
                if(displayScore > finalPercentage) displayScore = finalPercentage;
                scoreElement.textContent = displayScore;
            } else {
                clearInterval(anim);
            }
        }, 10);

        if(finalPercentage >= 90) {
            feedbackElement.innerHTML = `<strong>Outstanding!</strong> You have mastered Advanced Topics (MEMS/Gyros/Cams).`;
            document.querySelector('.score-circle').style.borderColor = "var(--success)";
        } else if(finalPercentage >= 70) {
            feedbackElement.innerHTML = `<strong>Great Job!</strong> Solid understanding of complex mechanics.`;
            document.querySelector('.score-circle').style.borderColor = "var(--secondary)";
        } else if(finalPercentage >= 50) {
            feedbackElement.innerHTML = `<strong>Good Effort.</strong> Review the MEMS fabrication techniques.`;
            document.querySelector('.score-circle').style.borderColor = "var(--accent)";
        } else {
            feedbackElement.innerHTML = `<strong>Keep Studying.</strong> Focus on the fundamental formulas.`;
            document.querySelector('.score-circle').style.borderColor = "var(--danger)";
        }

        document.getElementById('resultModal').style.display = 'flex';
    }
</script>
</body>
</html>