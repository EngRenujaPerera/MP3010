<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3010 - Student Portal</title>
    <style>
        :root {
            --primary: #3b82f6;
            --dark-bg: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --google-btn: #ffffff;
            --google-text: #3c4043;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }

        body {
            background-color: var(--dark-bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        #physics-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        .portal-container {
            position: relative; z-index: 10; width: 100%; max-width: 400px;
            background: var(--panel-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
            padding: 40px 30px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .logo-area { margin-bottom: 25px; font-size: 3rem; }
        h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 10px; }
        p { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 30px; line-height: 1.5; }

        /* Modern Google Button */
        .social-btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background: var(--google-btn); color: var(--google-text);
            border: none; border-radius: 50px; padding: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            gap: 12px; margin-bottom: 15px; text-decoration: none;
        }
        .social-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .social-btn:active { transform: translateY(0); }
        .social-icon { width: 20px; height: 20px; }

        .divider {
            display: flex; align-items: center; color: var(--text-muted);
            font-size: 0.8rem; margin: 25px 0;
        }
        .divider::before, .divider::after {
            content: ""; flex: 1; height: 1px; background: rgba(255,255,255,0.1);
        }
        .divider span { padding: 0 10px; }

        .status-msg { margin-top: 15px; font-size: 0.85rem; color: var(--primary); height: 20px; }

        @keyframes floatUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <canvas id="physics-canvas"></canvas>

    <div class="portal-container">
        <div class="logo-area">⚛️</div>
        <h1>Welcome Back</h1>
        <p>Log in to access MP3010 Kinematics & Dynamics course materials and quizzes.</p>

        <button class="social-btn" onclick="signInWithGoogle()">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="social-icon" alt="G">
            Continue with Google
        </button>

        <button class="social-btn" style="background:#1877F2; color:white;" onclick="alert('Facebook requires a verified Business Developer account. Stick to Google for this demo!')">
            <img src="https://www.svgrepo.com/show/475647/facebook-color.svg" class="social-icon" style="filter: brightness(0) invert(1);" alt="F">
            Continue with Facebook
        </button>

        <div class="divider"><span>OR</span></div>

        <p style="font-size: 0.8rem; margin:0;">
            University Login? <a href="#" style="color:var(--primary);">Click here</a>
        </p>

        <div id="status" class="status-msg"></div>
    </div>

    <script type="module">
        // 1. Import Authentication Functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. YOUR FIREBASE CONFIGURATION (Paste keys from Step 1)
        const firebaseConfig = {
            apiKey: "AIzaSyCKe-vpvKDsbj_jD2rxQWCy3DpYfvrDDBE",
            authDomain: "mp3010-6a710.firebaseapp.com",
            projectId: "mp3010-6a710",
            storageBucket: "mp3010-6a710.firebasestorage.app",
            messagingSenderId: "343091357206",
            appId: "1:343091357206:web:be695040f550dd32073737",
            measurementId: "G-V871T1YJ3K"
};

        // 3. Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // 4. Handle Google Sign-In
        window.signInWithGoogle = async function() {
            const status = document.getElementById('status');
            status.innerText = "Connecting to Google...";

            try {
                // This opens the popup window
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                status.innerText = "Verifying Student Data...";

                // Check if this student exists in database. If not, save them.
                const userRef = doc(db, "students", user.uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    // First time login! Create their profile automatically.
                    await setDoc(userRef, {
                        fullName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        lastLogin: serverTimestamp(),
                        enrolledDate: serverTimestamp(),
                        role: "student"
                    });
                } else {
                    // Returning user - just update last login
                    await setDoc(userRef, { lastLogin: serverTimestamp() }, { merge: true });
                }

                // Save session locally and redirect
                localStorage.setItem('currentUser', JSON.stringify({
                    name: user.displayName,
                    photo: user.photoURL,
                    email: user.email
                }));

                status.innerText = "Success! Redirecting...";
                setTimeout(() => { window.location.href = "index.html"; }, 1000);

            } catch (error) {
                console.error(error);
                status.innerText = "Error: " + error.message;
            }
        }

        // --- Background Animation (Same as before) ---
        const canvas = document.getElementById('physics-canvas');
        if(canvas) {
            const ctx = canvas.getContext('2d');
            let particles = [];
            function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
            window.addEventListener('resize', resize);
            resize();
            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                    this.vx = (Math.random() - 0.5) * 1.5; this.vy = (Math.random() - 0.5) * 1.5; this.size = Math.random() * 3 + 1;
                }
                update() {
                    this.x += this.vx; this.y += this.vy;
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
                }
                draw() {
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.5)';
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                }
            }
            function initParticles() {
                particles = [];
                const count = Math.min(window.innerWidth / 10, 100);
                for (let i = 0; i < count; i++) particles.push(new Particle());
            }
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < particles.length; i++) {
                    particles[i].update(); particles[i].draw();
                    for (let j = i; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 150) {
                            ctx.beginPath(); ctx.strokeStyle = `rgba(59, 130, 246, ${1 - dist / 150})`;
                            ctx.lineWidth = 0.5; ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke();
                        }
                    }
                }
                requestAnimationFrame(animate);
            }
            initParticles();
            animate();
        }
    </script>
</body>
</html>